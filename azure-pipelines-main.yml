trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  FEED_NAME: cdporgfeed
  ORG_NAME: dluhctst

steps:
- checkout: self

- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.11'

# # Authenticate pip/twine to Azure Artifacts feed
# - task: PipAuthenticate@1
#   inputs:
#     artifactFeeds: $(FEED_NAME)

# Authenticate Azure CLI
- script: |
      pip install --upgrade pip --target /opt/az/lib/python3.13/site-packages/ --index-url https://pypi.org/simple
      echo $(System.AccessToken) | az devops login
  displayName: 'Login to Azure DevOps CLI'

# Install pip, twine and azure artifact keyring (tmp remove "keyring artifacts-keyring")
- script: |
    python -m pip install --upgrade pip twine==6.0.1 --index-url https://pypi.org/simple
  displayName: Install packaging tools

# Retrieve newly added requirements
- script: |
    # Fetch latest `main` to compare with current branch
    git fetch origin main

    # Fetch the merged `requirements.txt` from the `main` branch
    git show origin/main:requirements.txt > old_requirements.txt || touch old_requirements.txt
    cp requirements.txt new_requirements.txt

    # Use `diff` to find new dependencies, ignoring lines starting with "#"
    diff old_requirements.txt new_requirements.txt | \
      grep "^>" | sed 's/^> //' | grep -v '^#' > added_packages.txt || true

    echo "New dependencies detected:"
    cat added_packages.txt || true

    # If no new dependencies were detected, fail the build
    if [ ! -s added_packages.txt ]; then
      echo "ERROR: No new dependencies detected in requirements.txt."
      echo "This pipeline must only be used when adding new dependencies."
      exit 1
    fi
  displayName: Detect newly added dependencies


# Download packages from PyPI into a temp folder
- script: |
    mkdir -p downloaded_packages
    python -m pip download -r added_packages.txt -d downloaded_packages --index-url https://pypi.org/simple
  displayName: Download packages from PyPI


# Upload newly downloaded packages to Azure Universal Package Feed
- script: |
    # Enable script to exit on error
    set -e

    # Define Universal Package Feed URL and organization
    FEED_URL="https://pkgs.dev.azure.com/$(ORG_NAME)/_packaging/$(FEED_NAME)/universal/upload/"

    # Loop through each package in the downloaded_packages folder
    for PACKAGE_FILE in downloaded_packages/*; do
      
      echo $PACKAGE_FILE

      # Get the package name and version from the file path
      PACKAGE_NAME=$(basename $PACKAGE_FILE | sed -E 's/([a-zA-Z0-9\-]+)-([0-9\.]+)-.*\.(whl|tar\.gz)$/\1/')
      PACKAGE_VERSION=$(basename $PACKAGE_FILE | sed -E 's/([a-zA-Z0-9\-]+)-([0-9\.]+)-.*\.(whl|tar\.gz)$/\2/')
      
      echo $PACKAGE_VERSION
      # Convert PACKAGE_NAME to lowercase
      PACKAGE_NAME="${PACKAGE_NAME,,}"

      # Retrieve absolute path of file
      ABSOLUTE_PATH="$(pwd)/$PACKAGE_FILE"

      echo "Processing package: $ABSOLUTE_PATH"

      az artifacts universal list --organization "https://dev.azure.com/$ORG_NAME" --feed "$FEED_NAME" --name "$PACKAGE_NAME" --version "$PACKAGE_VERSION"

      # # Check if package exists
      # if az artifacts universal list --organization "https://dev.azure.com/$ORG_NAME" --feed "$FEED_NAME" --name "$PACKAGE_NAME" --version "$PACKAGE_VERSION" &> /dev/null; then
      #   echo "Package $PACKAGE_NAME version $PACKAGE_VERSION already exists. Skipping..."
      #   continue
      # fi

      # Upload the package to the Universal Package Feed
      echo "Uploading $PACKAGE_NAME version $PACKAGE_VERSION to $FEED_URL"
      az artifacts universal publish \
        --organization https://dev.azure.com/$(ORG_NAME) \
        --feed $(FEED_NAME) \
        --name $PACKAGE_NAME \
        --version $PACKAGE_VERSION \
        --path $ABSOLUTE_PATH
    done
  displayName: Upload Packages to Universal Feed
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)



# # Upload downloaded packages to Azure Artifacts feed
# - script: |
#     twine upload \
#       --repository-url https://pkgs.dev.azure.com/$(ORG_NAME)/_packaging/$(FEED_NAME)/pypi/upload/ \
#       -u __token__ \
#       -p $SYSTEM_ACCESSTOKEN \
#       downloaded_packages/*
#   displayName: Upload packages to Azure Artifacts feed
#   env:
#     SYSTEM_ACCESSTOKEN: $(System.AccessToken)
