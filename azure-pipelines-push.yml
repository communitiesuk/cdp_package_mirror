trigger: none

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

schedules:
  - cron: "0 7 * * *"
    displayName: Run Scan Every Day at 7am
    branches:
      include:
        - main
    always: true

variables:
  - group: core-cdp-vars

steps:
# checkout current repository onto the build agent
- checkout: self
  fetchDepth: 0

# use Python version 3.12
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.12'

# install pip-audit for subsequent scanning step
- script: pip install pip-audit
  displayName: Install pip-audit

# run pip-audit scan and generate security report
- script: |
    mkdir -p audit-report

    if [ -s requirements.txt ]; then
      echo "Running pip-audit..."
      pip-audit \
        -r requirements.txt \
        --format json \
        --output audit-report/pip-audit-report.json || true
    else
      echo "No new dependencies" > audit-report/pip-audit-report.json
    fi
  displayName: Run pip-audit and generate report

# publish security report json to pipeline artifact
- task: PublishPipelineArtifact@1
  displayName: Publish pip-audit report
  inputs:
    targetPath: audit-report
    artifact: pip-audit-report

# ensure pipeline fails in the event of vulnerabilities
- script: |
    pip-audit -r requirements.txt
  displayName: Enforce security gate

# send Slack notification (reflects success or failure of the pipeline)
- script: |
    # Construct the pipeline URL (to the build results page)
    PIPELINE_URL="$(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
    
    # Construct the artifact URL by appending the "view=artifacts" to the pipeline URL
    ARTIFACT_URL="${PIPELINE_URL}&view=artifacts"
    
    # Determine the pipeline status
    PIPELINE_STATUS="succeeded"
    if [ "$(Build.Status)" != "Succeeded" ]; then
      PIPELINE_STATUS="failed"
    fi

    # Set message text based on pipeline status
    if [ "$PIPELINE_STATUS" == "succeeded" ]; then
      PIPELINE_MESSAGE="âœ… Daily Private Package Security Scan succeeded! Check the details and logs here: <${PIPELINE_URL}|Pipeline> | <${ARTIFACT_URL}|Scan Artifact>"
    else
      PIPELINE_MESSAGE="ðŸš¨ Daily Private Package Security Scan failed! Check the details and logs here: <${PIPELINE_URL}|Pipeline> | <${ARTIFACT_URL}|Scan Artifact>"
    fi

    # Send the Slack notification with both pipeline and artifact URLs as hyperlinks
    curl -X POST -H 'Content-type: application/json' --data "{
      \"text\": \"$PIPELINE_MESSAGE\"
    }" $(slack_webhook_url)  # Use the Slack Webhook URL from the variable group
  displayName: 'Notify Slack'
  condition: always() 
