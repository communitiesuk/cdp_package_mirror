trigger: none
pr:
  branches:
    include:
      - "*"

pool:
  vmImage: "windows-latest"

variables:
  FEED_SIMPLE_URL: "https://pkgs.dev.azure.com/dluhctst/CTDP-SLT/_packaging/CDP-TST/pypi/simple"
  SYSTEM_ACCESSTOKEN: $(System.AccessToken)

jobs:
- job: scan_and_install
  displayName: "Install dependencies and run pip-audit on Windows"
  steps:
    # Checkout code and persist credentials for System.AccessToken
    - checkout: self
      persistCredentials: 'true'

    # Use Python 3.12
    - task: UsePythonVersion@0
      inputs:
        versionSpec: "3.12"
        addToPath: true

    # Install artifacts-keyring and pip-audit globally
    - script: |
        python -m pip install --upgrade pip
        pip install keyring artifacts-keyring pip-audit
      displayName: "Install artifacts-keyring + pip-audit"
      env:
        ARTIFACTS_KEYRING_NONINTERACTIVE_MODE: "true"

    # Create virtual environment and install dependencies
    - script: |
        python -m venv .venv
        .venv\Scripts\python.exe -m pip install --upgrade pip
        .venv\Scripts\python.exe -m pip install -r requirements.txt --index-url "%FEED_SIMPLE_URL%" -vvv
      displayName: "Install dependencies from PyPI + Azure Artifacts feed"
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
        VSS_NUGET_EXTERNAL_FEED_ENDPOINTS: '{"endpointCredentials":[{"endpoint":"https://pkgs.dev.azure.com/dluhctst/CTDP-SLT/_packaging/CDP-TST/pypi/simple","username":"AzureDevOps","password":"$(System.AccessToken)"}]}'
        ARTIFACTS_KEYRING_NONINTERACTIVE_MODE: "true"

    # Run pip-audit inside the virtual environment
    - script: |
        call .venv\Scripts\activate.bat
        pip-audit || true
      displayName: "Run pip-audit"
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
        VSS_NUGET_EXTERNAL_FEED_ENDPOINTS: '{"endpointCredentials":[{"endpoint":"https://pkgs.dev.azure.com/dluhctst/CTDP-SLT/_packaging/CDP-TST/pypi/simple","username":"AzureDevOps","password":"$(System.AccessToken)"}]}'
        ARTIFACTS_KEYRING_NONINTERACTIVE_MODE: "true"
