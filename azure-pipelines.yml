trigger: none
pr:
  branches:
    include:
      - "*"

pool:
  vmImage: "ubuntu-latest"

variables:
  FEED_SIMPLE_URL: "https://pkgs.dev.azure.com/dluhctst/CTDP-SLT/_packaging/CDP-TST/pypi/simple"
  SYSTEM_ACCESSTOKEN: $(System.AccessToken)

jobs:
- job: scan_and_install
  displayName: "Install dependencies and run pip-audit"
  steps:
    # Checkout code and persist credentials for System.AccessToken
    - checkout: self
      persistCredentials: true

    # Use Python 3.12
    - task: UsePythonVersion@0
      inputs:
        versionSpec: "3.12"
        addToPath: true

    # Install authentication tools and pip-audit globally
    - script: |
        python -m pip install --upgrade pip
        pip install keyring artifacts-keyring pip-audit
        import keyring; print("Keyring backend:", keyring.get_keyring())
      displayName: "Install artifacts-keyring + pip-audit"
      env:
        ARTIFACTS_KEYRING_NONINTERACTIVE_MODE: "true"


    # Create virtual environment and install dependencies
    - script: |
        python -m venv .venv
        source .venv/bin/activate
        echo "Token length: ${SYSTEM_ACCESSTOKEN}"
        python -m pip install --upgrade pip
        # Use PyPI as main index, Azure Artifacts feed as extra index
        pip install requests --index-url "$FEED_SIMPLE_URL" -vvv
      displayName: "Install dependencies from PyPI + Azure Artifacts feed"
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
        VSS_NUGET_EXTERNAL_FEED_ENDPOINTS: '{"endpointCredentials":[{"endpoint":"https://pkgs.dev.azure.com/dluhctst/CTDP-SLT/_packaging/CDP-TST/pypi/simple","username":"AzureDevOps","password":"$(System.AccessToken)"}]}'
        ARTIFACTS_KEYRING_NONINTERACTIVE_MODE: "true"

    # Run pip-audit inside the virtual environment
    - script: |
        source .venv/bin/activate
        pip-audit || true
      displayName: "Run pip-audit"
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
        VSS_NUGET_EXTERNAL_FEED_ENDPOINTS: '{"endpointCredentials":[{"endpoint":"https://pkgs.dev.azure.com/dluhctst/CTDP-SLT/_packaging/CDP-TST/pypi/simple","username":"AzureDevOps","password":"$(System.AccessToken)"}]}'
 