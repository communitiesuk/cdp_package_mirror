trigger: none
pr:
  branches:
    include:
      - "*"

pool:
  vmImage: "ubuntu-latest"

variables:
  FEED_SIMPLE_URL: "https://pkgs.dev.azure.com/dluhctst/CTDP-SLT/_packaging/CDP-TST/pypi/simple/"

jobs:
- job: scan_only
  displayName: "Install deps & scan (no promotion)"
  steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: "3.12"
        addToPath: true

    - script: |
        python -m pip install --upgrade pip
        pip install keyring artifacts-keyring pip-audit
      displayName: "Install auth tooling + pip audit"
      env:
        ARTIFACTS_KEYRING_NONINTERACTIVE_MODE: "true"

    - script: |
        python -m venv .venv
        . .venv/bin/activate
        pip install -U pip
        pip config set global.index-url "$(FEED_SIMPLE_URL)"
        pip install -r requirements.txt
      displayName: "Install dependencies from Azure Artifacts feed"
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)

    - script: |
        source .venv/bin/activate
        pip-audit || true
      displayName: "Run pip-audit"
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
